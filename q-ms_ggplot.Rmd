---
title: "Plotting quantitative mass spec data with ggplot"
author: "Blake Paget"
date: '2021'
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, out.width = '100%')
```

## Background
The full methodology and underlying data (as supplementary) can be found at PLOS One within the research article referenced below.<br>
<br>
Paget BW, Kleffmann T, Whiteman KE, Thomas MF, McMahon CD (2023) Quantitative comparison of manuka and clover honey proteomes with royal jelly. PLOS ONE 18(2): e0272898. [https://doi.org/10.1371/journal.pone.0272898](https://doi.org/10.1371/journal.pone.0272898)<br>
<br>

In brief:<br>

 - Samples consisted of 12 manuka honey, 6 clover honey and 8 royal jelly.
 - Protein was extracted by dialysis and analysed by SWATH-MS at the University of Otago.
 - MS search database included all *Apis mellifera* NCBI RefSeq proteins.
 - For manuka samples 4 technical replicate LC-MS runs were performed, while clover and royal jelly had 3 technical replicates.
 - Normalised label-free quantitation data were tested for variance and normality using Fisher’s test and Shapiro-Wilk test, respectively.
 - A non-parametric bootstrap method was used to calculate 95% confidence intervals for biological replicates and p-values for the difference of means, using 10,000 replicates.
<br>

Notes on the data received:<br>

 - The samples were submitted at two different times - the manuka samples were analysed first on a 90 minute LC gradient, then several months later the clover and royal jelly samples were requested to be analysed in the exact same manner. However, it transpired that the clover samples were apparently not concentrated enough to run a 90 minute gradient, so instead this was shortened to a 60 minute gradient.
 - The loss of clover protein must have occured during MS prep as all submitted samples were a similar concentration.
 - Unfortunately we were not informed prior to the analysis and could easily have supplied more concentrated samples.
 - The royal jelly samples were therefore separated over 90 and 60 minute gradients. Hence the data only allows accurate comparison of manuka to royal jelly and separately clover to royal jelly.<br>
<br>

## R script
#### Import data
The csv files containing quantitative data were previously prepared in R.<br>
<br>

```{r libraries, message=FALSE, warning=FALSE}
# Load libraies.
library(tidyverse)
library(janitor)
```
<br>

```{r import_data_1, message=FALSE, warning=FALSE}
# Import relative quantification data.
quant <- read_csv("Quantitative_comparisons_2021.csv")
names(quant) <- make.names(names(quant))
glimpse(quant)
```
```{r import_data_2, message=FALSE, warning=FALSE}
# Import protein abundance data.
intens <- read_csv("intensity_comparisons_2021.csv")
names(intens) <- make.names(names(intens))
glimpse(intens)
```
<br>

#### Process data
Data was checked for unique accessions in each table then merged.
Protein descriptions were shortened.
The positions of asterisk characters indicating statistical significance were calculated.<br>
<br>

```{r process_data_1}
# Check for a primary key in each data set.
compare_df_cols(quant, intens)
# quant$Protein unique?
nrow(quant) == nrow(unique(quant[, c('Comparison', 'Protein')]))
# intens$Protein.Name unique?
nrow(intens) == nrow(unique(intens[, c('Comparison', 'Protein.Name')]))
```
<br>

```{r merge_data, message=FALSE, warning=FALSE}
# Merge on Comparison, Protein.Description, Protein/Protein.Name.
intens <- rename(intens, Protein = Protein.Name)
df <- merge(quant, intens, by = c("Comparison", "Protein.Description", "Protein"))
glimpse(df)
```
```{r include=FALSE}
rm(intens, quant)
```
<br>

```{r}
# Clean up descriptions.
to_remove <- c(" \\[Apis mellifera\\]", " precursor", " preproprotein", " \\[FAD, quinone\\]")
df <- 
  df %>% 
  mutate(Protein.Description = str_remove_all(Protein.Description, paste(to_remove, collapse = "|"))) %>% 
  mutate(Protein.Description = str_replace_all(Protein.Description, "uncharacterized protein", "UP"))
```
<br>

```{r}
# Calculate coordinates for significance symbols, define significance labels.
lab_pos_adjust <- 1.5
df$lab_pos <- ifelse(df$Log2.Fold.Change > 0, df$Log2.Max + lab_pos_adjust, df$Log2.Min - lab_pos_adjust)
df$sig_pos <- 
  case_when(
    df$lab_pos < 0 ~ case_when(
      df$Adjusted.P.Value < 0.001 ~ "***",
      df$Adjusted.P.Value < 0.01 ~ " **",
      df$Adjusted.P.Value < 0.05 ~ "  *",
      .default = ""
    ),
    .default = case_when(
      df$Adjusted.P.Value < 0.001 ~ "***",
      df$Adjusted.P.Value < 0.01 ~ "** ",
      df$Adjusted.P.Value < 0.05 ~ "*  ",
      .default = ""
    )
  )
```
<br>

#### Plot setup
The facet_grid labeller requires a vector of named labels to label the facets.
The names should be factors in the data supplied to the ggplot function.
Outlying low or high values for the 'fill' aesthetic will stretch the legend beyond the manually applied breaks and labels, and produce a skewed colour filling of the bars. A low outlier for M_vs_R, lysozyme was manually changed to prevent this happening, so that lysozyme still appears as the lowest fill value (indistinguishable when viewing the graph) but preserves the manually changed fill legend appearance.<br>
<br>

```{r}
# Define the labels for the facet_grid.
comparison_names <- c('M_vs_R' = "Manuka\nvs\nRoyal jelly",
                      'C_vs_R' = "Clover\nvs\nRoyal jelly",
                      'MRJPs' = "MRJPs",
                      'Glycosidases' = "Glycosidases",
                      'Oxidoreductases' = "Oxidoreductases",
                      'Esterases' = "Esterases",
                      'Peptidases' = "Peptidases",
                      'Peptidase inhibitors' = "Peptidase inhibitors",
                      'Immune response' = "Immune response",
                      'Lipid transport' = "Lipid transport",
                      'Allergen' = "Allergen",
                      'Uncharacterized' = "Uncharacterized")
```

<br>
```{r}
# Make all the labels factors in the dataframe.
df$Comparison <- factor(df$Comparison, levels = c("M_vs_R", "C_vs_R"))
df$function. <- factor(df$function., levels = c("MRJPs", "Glycosidases", "Oxidoreductases", "Esterases", "Peptidases", "Peptidase inhibitors", "Immune response", "Lipid transport", "Allergen", "Uncharacterized"))

```

```{r}
# Final glimpse of types.
glimpse(df)
```


```{r}
# Specifically edit the Mean value for "Comparison == 'M_vs_R' & Protein.Description == 'lysozyme'" because it is 100x less than any other and stretches the legend down to below 0.001%.
df <- df %>% mutate(Mean = ifelse(Comparison == "M_vs_R" & Protein.Description == 'lysozyme', 0.00041, Mean))
```
<br>

#### Plot
Some plot variables can be defined prior to the call to ggplot to tidy up that code. If multiple graphs were to be produced then some of the core theme components could be grouped under a single variable just like the built-int themes are e.g. theme_classic(), theme_minimal(). It might be that one of these built-in themes is very close to what I have produced here.
<br>

```{r plot, fig.height=7}
# Easily change the bar fill colour below.
fill_colour <- "green"

# Titles and caption.
title <- "Comparative analyses of mānuka and clover honey to royal jelly by SWATH-MS"
subtitle <- "See accompanying R code for rendering various aspects of the graph"
caption <- 
  "Figure. Quantitative comparisons of proteins identified by both analysis methods, expressed as the log2-fold change in
  sum of peak intensities for each honey protein compared to the corresponding protein found in royal jelly. Apisimin was
  added from the SWATH-MS analysis, giving 32 proteins in total. The shading of the bars represents the mean peptide
  intensity of protein in the honey samples (mānuka, n = 12; clover, n = 6, royal jelly n = 8). Significant differences
  are indicated by * P < 0.05, ** P < 0.01, *** P < 0.001. https://doi.org/10.1371/journal.pone.0272898.g002"

# Plot.
ggplot(data = df,
       mapping = aes(x = Log2.Fold.Change, y = reorder(Protein.Description, desc(group_order)))) +
  geom_bar(data = df,
           aes(fill = Mean),
           stat = "identity",
           color = "black",
           width = 0.8) +
  geom_errorbar(width = 0.4,
                aes(xmin = Log2.Min, xmax = Log2.Max)) +
  scale_fill_gradient(guide = "legend",
                      low = "white",
                      high = fill_colour,
                      trans = "log10",
                      breaks = c(0.001, 0.003, 0.01, 0.03, 0.1, 0.30),
                      labels = c("0.1%", "0.3%", "1%", "3%", "10%", "30%")) +
  scale_x_continuous(limits = c(-9.5, 9.5),
                     breaks = c(-8, -6, -4, -2, 0, 2, 4, 6, 8)) +
  labs(title = title,
       subtitle = subtitle,
       caption = caption, 
       x = expression(paste(Log[2], " fold-change in honey protein")),
       y = NULL) +
  theme(panel.border = element_rect(color = "grey60", fill = NA),
        axis.line.x = element_line(color = "black"),
        axis.ticks.y = element_blank(),
        panel.grid.major.y=element_blank(),
        panel.background = element_blank(),
        panel.grid = element_line(color = "grey90"),
        panel.grid.major.x = element_line(linewidth = 0.25),
        legend.position = "right",
        plot.caption.position = "plot",
        plot.caption = element_text(hjust = 0),
        plot.title.position = "plot",
        panel.spacing = unit(0, "lines"),
        strip.placement = "outside",
        strip.text.y.right = element_text(angle = 0),
        strip.background = element_rect(color = "grey60", fill = "white")) +
  guides(fill = guide_colorbar("Protein\nabundance\nin honey",
                               barwidth = 0.5, barheight = 10,
                               ticks.colour = "black",
                               frame.colour = "black",
                               frame.linewidth = 0.8)) +
  geom_hline(yintercept = seq(1.5, length(unique(df$Protein.Description))-0.5, 1),
             lwd = 0.2,
             color = "grey90") +
  geom_vline(xintercept = 0) +
  geom_text(aes(x = lab_pos, label = sig_pos),
            position = position_dodge(0.9),
            vjust = 0.7,
            size = 3,
            color = "grey30") +
  facet_grid(function. ~ Comparison,
             scales = "free_y",
             space = "free_y",
             labeller = as_labeller(comparison_names))

```
<br>
<br>
<br>

## Summary
The way the data was collected made it difficult to compare samples in the manner we would have liked. Obvioulsy if all data were collected in the same way then relative quantities could be compared between the three sample types. Graphs would most likely be grouped by MRJPs, known enzymes, remaining characterised proteins and uncharacterised proteins for better clarity and ease of interpretation with all three sample types compared in grouped bars.<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
*End of document*